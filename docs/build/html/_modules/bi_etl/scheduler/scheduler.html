<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>bi_etl.scheduler.scheduler &mdash; bi_etl 0.5 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="bi_etl 0.5 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">bi_etl 0.5 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for bi_etl.scheduler.scheduler</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Created on Apr 14, 2015</span>

<span class="sd">@author: woodd</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">textwrap</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.orm.exc</span> <span class="kn">import</span> <span class="n">DetachedInstanceError</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">Queue</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="kn">import</span> <span class="nn">warnings</span>


<span class="kn">import</span> <span class="nn">bi_etl.scheduler</span>
<span class="kn">from</span> <span class="nn">bi_etl.scheduler.messages</span> <span class="kn">import</span> <span class="n">ChildSetDisplayName</span>
<span class="kn">from</span> <span class="nn">bi_etl.conversions</span> <span class="kn">import</span> <span class="n">replace_tilda</span>
<span class="kn">from</span> <span class="nn">bi_etl.statistics</span> <span class="kn">import</span> <span class="n">Statistics</span>
<span class="kn">from</span> <span class="nn">bi_etl.utility</span> <span class="kn">import</span> <span class="n">dict_to_pairs</span>
<span class="kn">from</span> <span class="nn">bi_etl.scheduler.task</span> <span class="kn">import</span> <span class="n">Status</span><span class="p">,</span> <span class="n">TaskStopRequested</span><span class="p">,</span> <span class="n">ETLTask</span>
<span class="kn">from</span> <span class="nn">bi_etl.scheduler.scheduler_etl_jobs.etl_task_status_cd</span> <span class="kn">import</span> <span class="n">ETL_Task_Status_CD</span>
<span class="kn">import</span> <span class="nn">bi_etl.scheduler.dependent_reasons</span> <span class="kn">as</span> <span class="nn">dependent_reasons</span>
<span class="kn">from</span> <span class="nn">bi_etl.scheduler.scheduler_interface</span> <span class="kn">import</span> <span class="n">SchedulerInterface</span>
<span class="kn">from</span> <span class="nn">bi_etl.scheduler.messages</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ChildStatusUpdate</span><span class="p">,</span>
                                       <span class="n">ChildRunRequested</span><span class="p">,</span>
                                       <span class="n">ChildRunOK</span><span class="p">,</span>
                                       <span class="n">ChildNotOccupyingCPU</span><span class="p">,</span>
                                       <span class="n">ChildOccupyingCPU</span><span class="p">,</span>
                                       <span class="n">SummaryMessage</span>
                                       <span class="p">)</span>
<span class="kn">from</span> <span class="nn">bi_etl.scheduler.models</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ETL_Tasks</span><span class="p">,</span>
                                     <span class="n">ETL_Task_Log</span><span class="p">,</span>
                                     <span class="n">ETL_Task_Stats</span><span class="p">,</span>
                                     <span class="n">ETL_Task_Dependency</span>
                                     <span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">InvalidRequestError</span>
<span class="kn">from</span> <span class="nn">bi_etl.scheduler.exceptions</span> <span class="kn">import</span> <span class="n">CircularDependency</span>
<span class="kn">from</span> <span class="nn">bi_etl.scheduler.exceptions</span> <span class="kn">import</span> <span class="n">DependencyDeeperThanLimit</span>
                                         

<span class="c1">#pylint: disable=too-many-instance-attributes, too-many-public-methods, too-many-nested-blocks </span>
<span class="c1">#pylint: disable=too-many-statements, too-many-branches, too-many-arguments, too-many-locals</span>
<span class="c1">#pylint: disable=invalid-name</span>

<span class="c1">## Ignore long lines for now</span>
<span class="c1">#pylint: disable=line-too-long</span>

<div class="viewcode-block" id="Scheduler"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler">[docs]</a><span class="k">class</span> <span class="nc">Scheduler</span><span class="p">(</span><span class="n">SchedulerInterface</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Full-scheduler object with memory of active jobs.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">MAX_DEPENDENTS_DEPTH</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Scheduler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">log_name</span><span class="o">=</span><span class="s1">&#39;Scheduler&#39;</span><span class="p">,</span> <span class="n">allow_create</span><span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Register the replace_tilda method of handling unicode errors </span>
        <span class="n">codecs</span><span class="o">.</span><span class="n">register_error</span><span class="p">(</span><span class="s1">&#39;replace_tilda&#39;</span><span class="p">,</span> <span class="n">replace_tilda</span><span class="p">)</span>
        
        <span class="c1">## Use the spawn method to get a clean python instance for each ETL Job </span>
        <span class="n">multiprocessing</span><span class="o">.</span><span class="n">set_start_method</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">)</span>  <span class="c1"># @UndefinedVariable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getboolean_or_default</span><span class="p">(</span><span class="s1">&#39;Scheduler&#39;</span><span class="p">,</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Init full Scheduler instance&quot;</span><span class="p">)</span>

        <span class="c1">## TODO: Setup to monitor config file and reload if it changes</span>

        <span class="c1">## Only used by the full scheduler so we import here</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">psutil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psutil</span> <span class="o">=</span> <span class="n">psutil</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">maximum_concurrent_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint_or_default</span><span class="p">(</span><span class="s1">&#39;Scheduler&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;maximum_concurrent_tasks&#39;</span><span class="p">,</span> 
                                                                 <span class="bp">None</span>
                                                                 <span class="p">)</span>
        <span class="k">if</span> <span class="n">maximum_concurrent_tasks</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">maximum_concurrent_tasks</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>  <span class="c1"># @UndefinedVariable</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                      Setting maximum_concurrent_tasks to CPU count of {}.</span>
<span class="s1">                      Provide Scheduler.maximum_concurrent_tasks in config if something else is desired.</span>
<span class="s1">                      &#39;&#39;&#39;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_concurrent_tasks</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">maximum_concurrent_tasks</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                      Defaulting to {} concurrent tasks. </span>
<span class="s1">                      Provide maximum_concurrent_tasks in config if something else is desired.</span>
<span class="s1">                      &#39;&#39;&#39;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_concurrent_tasks</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maximum_concurrent_tasks</span> <span class="o">=</span> <span class="n">maximum_concurrent_tasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;maximum_concurrent_tasks = {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maximum_concurrent_tasks</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks_occupying_cpu</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_flush_interval</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_check_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint_or_default</span><span class="p">(</span><span class="s1">&#39;Scheduler&#39;</span><span class="p">,</span><span class="s1">&#39;process_check_interval&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_keep_finished_tasks</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">days_to_keep_run_logs</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">days_to_keep_large_parameters</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_large_parameter_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="c1">## Parameters over 1 KB are considered large</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_table_maintenance_run</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Finished Init full Scheduler instance&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_tasks_query</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">heartbeat_age_timedelta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_heartbeat_age_timedelta</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">heartbeat_age_timedelta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> 
            <span class="ow">and</span> <span class="n">heartbeat_age_timedelta</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_check_interval</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Another scheduler appears to be active!&#39;</span><span class="p">)</span>
        
        

    <span class="k">def</span> <span class="nf">_create_etl_task_object_from_task_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_rec</span><span class="p">):</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">task_id</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">task_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
        <span class="n">parent_task_id</span> <span class="o">=</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">parent_task_id</span>
        <span class="n">root_task_id</span> <span class="o">=</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">root_task_id</span>
        <span class="n">parent_task</span><span class="o">=</span><span class="bp">None</span>
        <span class="n">root_task</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">parent_task_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">parent_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_by_id</span><span class="p">(</span><span class="n">task_rec</span><span class="o">.</span><span class="n">parent_task_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent_task</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Task {} {} started with parent id {} that is not known&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">modulename</span><span class="p">,</span> <span class="n">parent_task_id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">## Check parent status</span>
                <span class="k">if</span> <span class="n">parent_task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">succeeded</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">parent_task</span><span class="p">,</span> <span class="s1">&#39;Child started status changing to ancestors_running&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">parent_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">ancestors_running</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">parent_task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">is_terminated</span><span class="p">()</span> <span class="ow">or</span> <span class="n">parent_task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">is_termination_pending</span><span class="p">():</span>
                    <span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">stop_requested</span>
                <span class="k">elif</span> <span class="n">parent_task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>
                    <span class="c1">#pylint: disable= redefined-variable-type</span>
                    <span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">stopped</span>

                <span class="k">if</span> <span class="n">root_task_id</span> <span class="o">!=</span> <span class="n">parent_task_id</span> <span class="ow">and</span> <span class="n">root_task_id</span> <span class="o">!=</span> <span class="n">parent_task</span><span class="o">.</span><span class="n">root_task_id</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Creating task {task_id} listed as has having parent_task_id={parent_task_id} which has root_task_id={root_task_id}...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">task_id</span> <span class="o">=</span> <span class="n">task_id</span><span class="p">,</span>
                                        <span class="n">parent_task_id</span> <span class="o">=</span> <span class="n">parent_task_id</span><span class="p">,</span>
                                        <span class="n">root_task_id</span> <span class="o">=</span> <span class="n">parent_task</span><span class="o">.</span><span class="n">root_task_id</span><span class="p">,</span>
                                        <span class="p">)</span>
                                     <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;...however, parent database record has root_task_id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root_task_id</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;...correcting the task database row&quot;</span><span class="p">)</span>
                    <span class="n">task_rec</span><span class="o">.</span><span class="n">root_task_id</span> <span class="o">=</span> <span class="n">parent_task</span><span class="o">.</span><span class="n">root_task_id</span>
                    <span class="n">root_task_id</span> <span class="o">=</span> <span class="n">parent_task</span><span class="o">.</span><span class="n">root_task_id</span>
        <span class="k">if</span> <span class="n">root_task_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">root_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_by_id</span><span class="p">(</span><span class="n">root_task_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent_task</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">parent_task</span> <span class="o">=</span> <span class="n">root_task</span>
            <span class="k">if</span> <span class="n">root_task</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Task {} {} started with root id {} that is not known&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">modulename</span><span class="p">,</span> <span class="n">root_task_id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">root_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">is_finished</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">root_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">ancestors_running</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">##Support finding the instance using either module alone (which could include an embedded classname) or module + classname</span>
            <span class="k">if</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">classname</span><span class="p">:</span>                
                <span class="n">instance_name</span> <span class="o">=</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">modulename</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">classname</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">instance_name</span> <span class="o">=</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">modulename</span>
            
            <span class="n">ETLTask_Class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_etl_class_instance</span><span class="p">(</span><span class="n">partial_module_name</span><span class="o">=</span> <span class="n">instance_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_log_message</span><span class="p">(</span><span class="n">task_rec</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">task_rec</span><span class="o">.</span><span class="n">summary_message</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">failed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">etl_task</span> <span class="o">=</span> <span class="n">ETLTask_Class</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span> <span class="n">task_id</span><span class="p">,</span>
                                     <span class="n">parent_task_id</span><span class="o">=</span><span class="n">parent_task_id</span><span class="p">,</span>
                                     <span class="n">root_task_id</span><span class="o">=</span><span class="n">root_task_id</span><span class="p">,</span>
                                     <span class="n">scheduler</span><span class="o">=</span> <span class="bp">self</span><span class="p">,</span>
                                     <span class="n">task_rec</span> <span class="o">=</span> <span class="n">task_rec</span><span class="p">,</span>
                                     <span class="n">config</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                                     <span class="p">)</span>
        <span class="c1">## Scheduler doesn&#39;t die no matter what!</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1">#pylint: disable=broad-except</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_log_message</span><span class="p">(</span><span class="n">task_rec</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">task_rec</span><span class="o">.</span><span class="n">summary_message</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">failed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Task {} object created in memory&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)))</span>
        <span class="c1">## Make extra sure ETLTask stored the task_ids properly</span>
        <span class="k">assert</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span> <span class="o">==</span> <span class="n">task_id</span>
        <span class="k">assert</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">parent_task_id</span> <span class="o">==</span> <span class="n">parent_task_id</span>
        <span class="k">assert</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">root_task_id</span> <span class="o">==</span> <span class="n">root_task_id</span>

        <span class="k">return</span> <span class="n">etl_task</span>

<div class="viewcode-block" id="Scheduler.get_task_by_id"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.get_task_by_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_task_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">etl_task_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">etl_task_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">etl_task_id</span><span class="p">)</span>
        <span class="c1">## Check active tasks in memory</span>
        <span class="k">if</span> <span class="n">etl_task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span><span class="p">[</span><span class="n">etl_task_id</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## Otherwise try to get it from the database</span>
            <span class="n">task_rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_record</span><span class="p">(</span><span class="n">etl_task_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_etl_task_object_from_task_rec</span><span class="p">(</span><span class="n">task_rec</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Scheduler.get_etl_tasks_by_name"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.get_etl_tasks_by_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_etl_tasks_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">etl_task_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_name</span><span class="p">[</span><span class="n">etl_task_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
</div>
<div class="viewcode-block" id="Scheduler.add_task_to_active"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.add_task_to_active">[docs]</a>    <span class="k">def</span> <span class="nf">add_task_to_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">ETLTask</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span><span class="p">[</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">etl_task</span>
        <span class="n">task_name</span> <span class="o">=</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">task_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_name</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_name</span><span class="p">[</span><span class="n">task_name</span><span class="p">][</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">etl_task</span>
</div>
<div class="viewcode-block" id="Scheduler.remove_active_task_record"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.remove_active_task_record">[docs]</a>    <span class="k">def</span> <span class="nf">remove_active_task_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">):</span>
        <span class="c1">## Last chance to flush message queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush_log_messages</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">etl_task_name</span> <span class="o">=</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">name</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;thread_running&#39;</span><span class="p">):</span>
                <span class="c1">## Stopped before it was started</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">thread_running</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;remove_active_task_record called with Task {} but has thread_running = True&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing completed task {} from active tasks&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">expunge</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">except</span> <span class="n">InvalidRequestError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span><span class="p">[</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">]</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_name</span><span class="p">[</span><span class="n">etl_task_name</span><span class="p">][</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">]</span>
                <span class="c1">## Remove children</span>
                <span class="k">for</span> <span class="n">child_task</span> <span class="ow">in</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_active_task_record</span><span class="p">(</span><span class="n">child_task</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ETL Task {} was not in etl_task_by_name&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="Scheduler.set_task_status"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.set_task_status">[docs]</a>    <span class="k">def</span> <span class="nf">set_task_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">,</span> <span class="n">new_status</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;set_task_status task_id={} new_status={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">new_status</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s2">&quot;set_task_status new_status={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_status</span><span class="p">))</span>

        <span class="c1">## Set status on both the object and the task_rec</span>
        <span class="c1">## TODO: Clean that up</span>
        <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">new_status</span>

        <span class="k">if</span> <span class="n">new_status</span><span class="o">.</span><span class="n">is_finished</span><span class="p">():</span>
            <span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">finished_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="c1">#self.log.debug(&quot;Task row = {}&quot;.format(dict_to_str(etl_task.task_rec)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c1">## Check if parent wants child status updates</span>
        <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">parent_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">parent_task</span><span class="o">.</span><span class="n">needs_to_get_child_statuses</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_task_message</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">parent_task</span><span class="p">,</span> <span class="n">ChildStatusUpdate</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">new_status</span><span class="p">))</span>
        <span class="c1">## Check if root wants ancestor status updates</span>
        <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">root_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">root_task</span> <span class="o">!=</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">parent_task</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">root_task</span><span class="o">.</span><span class="n">needs_to_get_ancestor_statuses</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_task_message</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">root_task</span><span class="p">,</span> <span class="n">ChildStatusUpdate</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">new_status</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Scheduler.send_task_message"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.send_task_message">[docs]</a>    <span class="k">def</span> <span class="nf">send_task_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">etl_task</span><span class="o">.</span><span class="n">parent_to_child</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;send_task_message called on task {} with no parent_to_child&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Scheduler.set_task_summary_message"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.set_task_summary_message">[docs]</a>    <span class="k">def</span> <span class="nf">set_task_summary_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">,</span> <span class="n">summary_message</span><span class="p">,</span> <span class="n">commit</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">from_client</span><span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        set the tasks summary message.</span>
<span class="sd">        Note: Since this is often called on conjunction with set_task_status, we default to no commit here.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">summary_message</span><span class="p">,</span> <span class="n">allow_duplicates</span><span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;set_task_summary_message task={} message={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">summary_message</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">summary_message_from_client</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">from_client</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not storing summary message because it would override a client message&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">summary_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">summary_message</span><span class="p">)[:</span><span class="mi">4000</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">commit</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Scheduler.append_task_summary_message"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.append_task_summary_message">[docs]</a>    <span class="k">def</span> <span class="nf">append_task_summary_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">,</span> <span class="n">summary_message</span><span class="p">,</span> <span class="n">commit</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Append to the tasks summary message.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_task_summary_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">summary_message</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">summary_message</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">commit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Scheduler.check_for_cpu"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.check_for_cpu">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks for available CPU, if available it STARTS THE TASK and returns True.</span>
<span class="sd">        If not it returns False</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks_occupying_cpu</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum_concurrent_tasks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_task</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_depth_first_dependent_search</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">current_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">call_tree</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">current_depth</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DependencyDeeperThanLimit</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">call_tree</span><span class="p">)</span>

        <span class="c1">## Make sure we are dealing with the ETL_Tasks task record from the model and not the ETL_Task object</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">ETLTask</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">task_rec</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ETLTask</span><span class="p">):</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">task_rec</span>

        <span class="k">if</span> <span class="n">call_tree</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">call_tree</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">call_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">start</span><span class="o">.</span><span class="n">task_id</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">call_tree</span>

        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">start</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
            <span class="c1">#if u.dependent_reason == dependent_reasons.Predecessor:</span>
            <span class="c1">## TODO: Track the u.dependent_reason in the call_tree</span>
            <span class="k">if</span> <span class="n">Scheduler</span><span class="o">.</span><span class="n">_depth_first_dependent_search</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">dependent_on_task</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">current_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">call_tree</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">call_tree</span>

        <span class="c1">## Remove ourselves from the master call tree</span>
        <span class="n">call_tree</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

<div class="viewcode-block" id="Scheduler.add_dependency"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.add_dependency">[docs]</a>    <span class="k">def</span> <span class="nf">add_dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">,</span> <span class="n">dependent_task</span><span class="p">,</span> <span class="n">dependent_reason</span><span class="p">):</span>
        <span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">ETLTask</span><span class="p">),</span> <span class="s1">&#39;add_dependency: etl_task is not an ETLTask but is a {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">etl_task</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dependent_task</span><span class="p">,</span> <span class="n">ETLTask</span><span class="p">),</span> <span class="s1">&#39;add_dependency: dependent_task is not an ETLTask but is a {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">dependent_task</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">dependent_task</span><span class="o">.</span><span class="n">task_id</span> <span class="o">==</span> <span class="n">ETLTask</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;Not recording dependency on {} since that is this task&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">dependent_task</span><span class="p">)))</span>
            <span class="k">return</span>
        <span class="c1">## Don&#39;t depend on cross root tasks that are already dependent on something in our root</span>
        <span class="k">if</span> <span class="n">dependent_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">root_task_id</span> <span class="o">!=</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">root_task_id</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dep_dep_record</span> <span class="ow">in</span> <span class="n">dependent_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
                <span class="n">dep_dep_task_rec</span> <span class="o">=</span> <span class="n">dep_dep_record</span><span class="o">.</span><span class="n">dependent_on_task</span>
                <span class="k">if</span> <span class="n">dep_dep_task_rec</span><span class="o">.</span><span class="n">root_task_id</span> <span class="o">==</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">root_task_id</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;Not recording dependency on {} since it is waiting on our root&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">dependent_task</span><span class="p">)))</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">exist_dep</span> <span class="ow">in</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exist_dep</span><span class="o">.</span><span class="n">dependent_on_task_id</span> <span class="o">==</span> <span class="n">dependent_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">exist_dep</span><span class="o">.</span><span class="n">current_blocking_flag</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;Re-blocking dependency on {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">dependent_task</span><span class="p">)))</span>
                        <span class="n">exist_dep</span><span class="o">.</span><span class="n">current_blocking_flag</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;Already dependent on {} blocking_flag = {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">dependent_task</span><span class="p">),</span> <span class="n">exist_dep</span><span class="o">.</span><span class="n">current_blocking_flag</span><span class="p">))</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="c1">## Make sure dependent_task isn&#39;t also directly or indirectly dependent on etl_task</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">.</span><span class="n">_depth_first_dependent_search</span><span class="p">(</span><span class="n">start</span><span class="o">=</span> <span class="n">dependent_task</span><span class="o">.</span><span class="n">task_rec</span><span class="p">,</span>
                                                           <span class="n">target</span><span class="o">=</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="p">,</span>
                                                           <span class="n">limit</span><span class="o">=</span> <span class="n">Scheduler</span><span class="o">.</span><span class="n">MAX_DEPENDENTS_DEPTH</span>
                                                           <span class="p">)</span>
            <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CircularDependency</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;Adding dependency on {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">dependent_task</span><span class="p">)))</span>
                <span class="n">dep</span> <span class="o">=</span> <span class="n">ETL_Task_Dependency</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="p">,</span> <span class="n">dependent_task</span><span class="o">.</span><span class="n">task_rec</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">dependent_reason</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Scheduler.check_dependencies"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.check_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">check_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">):</span>
        <span class="c1">#pylint: disable=protected-access</span>
        
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">ETLTask</span><span class="p">),</span> <span class="s2">&quot;check_dependencies needs an ETLTask got a {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">etl_task</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">_logged_dependencies</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;depends_on = {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">depends_on</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;normalized_dependents_set = {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">normalized_dependents_set</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;mutually_exclusive_with_set = {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">mutually_exclusive_with_set</span><span class="p">))</span>
            <span class="n">etl_task</span><span class="o">.</span><span class="n">_logged_dependencies</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">dependencies_met</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1">## Scan existing dependencies to check if they are still relevant</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dep</span><span class="o">.</span><span class="n">current_blocking_flag</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
                <span class="n">dep_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_by_id</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">dependent_on_task_id</span><span class="p">)</span>
                <span class="n">dependent_reason_class</span> <span class="o">=</span> <span class="n">dependent_reasons</span><span class="o">.</span><span class="n">getFromString</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">dependent_reason</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dependent_reason_class</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;Unable to process dependent_reason {}. Assuming it will get re-added. dep_task= {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">dep_task</span><span class="p">)))</span>
                    <span class="n">dep</span><span class="o">.</span><span class="n">current_blocking_flag</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span>
                <span class="k">elif</span> <span class="n">dependent_reason_class</span><span class="o">.</span><span class="n">release_wait_on_status</span><span class="p">(</span><span class="n">dep_task</span><span class="o">.</span><span class="n">status</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;No longer blocked by {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">dep_task</span><span class="p">)))</span>
                    <span class="n">dep</span><span class="o">.</span><span class="n">current_blocking_flag</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;{} still blocked by {} {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">),</span> <span class="n">dep</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">dep_task</span><span class="p">)))</span>
                    <span class="n">dependencies_met</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">elif</span> <span class="n">dep</span><span class="o">.</span><span class="n">current_blocking_flag</span> <span class="o">!=</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;{} current_blocking_flag has unexpected value of {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">current_blocking_flag</span><span class="p">))</span>

        <span class="c1">## Check for new dependencies</span>

        <span class="c1">## Check jobs that we depend on to make sure they are not actively running or failed</span>
        <span class="c1">## For example given jobs A-&gt; B -&gt; C</span>
        <span class="c1">## If A is running then B should not start</span>
        <span class="c1">## If A failed, then B should fail</span>
        <span class="k">for</span> <span class="n">dep_name</span> <span class="ow">in</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">normalized_dependents_set</span><span class="p">:</span>
            <span class="c1">## Check if that task name is active (running, or waiting)</span>
            <span class="n">dep_obj_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_etl_tasks_by_name</span><span class="p">(</span><span class="n">dep_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dep_obj_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dep_obj_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1">## Scan the entire list as dependent objects</span>
                <span class="k">for</span> <span class="n">dep_task_id</span> <span class="ow">in</span> <span class="n">dep_obj_dict</span><span class="p">:</span>
                    <span class="n">dep_task</span> <span class="o">=</span> <span class="n">dep_obj_dict</span><span class="p">[</span><span class="n">dep_task_id</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dep_task</span><span class="p">,</span> <span class="n">ETLTask</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">dependent_reasons</span><span class="o">.</span><span class="n">Predecessor</span><span class="o">.</span><span class="n">wait_on_status</span><span class="p">(</span><span class="n">dep_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">dep_task</span><span class="p">,</span> <span class="n">dependent_reasons</span><span class="o">.</span><span class="n">Predecessor</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Task {etl_task} has to wait because dependent job {dep} has not is_finished yet.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">),</span> <span class="n">dep</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">dep_task</span><span class="p">)))</span>
                            <span class="n">dependencies_met</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="k">except</span> <span class="n">CircularDependency</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                            <span class="c1">## Somehow that task is waiting for us, so we&#39;ll skip waiting on it</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;Did not add dependency on {} due to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">dep_task</span><span class="p">),</span> <span class="n">error</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1">## Failed</span>
                        <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">root_task_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">dep_task</span><span class="o">.</span><span class="n">root_task_id</span> <span class="o">==</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">root_task_id</span><span class="p">:</span>
                            <span class="c1">## If our predecessor within the same root failed, cancel this job</span>
                            <span class="k">if</span> <span class="n">dep_task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">dep_task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">is_termination_pending</span><span class="p">():</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Predecessor {} failed with status {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">dep_task</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">dep_task</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Task {etl_task} {msg}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">),</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">allow_duplicates</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">set_task_summary_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s2">&quot;Predecessor {} failed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dep_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">cancelled</span><span class="p">)</span>
                                <span class="k">return</span>
                        <span class="k">else</span><span class="p">:</span> <span class="c1">## Different root task instance failed (any tasks with root of None are considered different)</span>
                            <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s2">&quot;Predecessor {} is not registered with scheduler&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dep_name</span><span class="p">))</span>

        <span class="c1">## Check to see if another instance of this task is running</span>
        <span class="c1">## Check if that task name is active (running, or waiting)</span>
        <span class="c1">## TODO: Have a way that tasks can indicate if it&#39;s OK for another instance to run at the same time.</span>
        <span class="k">if</span> <span class="n">dependencies_met</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">exclusive_etl_task</span> <span class="ow">in</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">mutually_exclusive_with_set</span><span class="p">:</span>
                <span class="n">exclusive_etl_task_obj_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_etl_tasks_by_name</span><span class="p">(</span><span class="n">exclusive_etl_task</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">exclusive_etl_task_instance_task_id</span> <span class="ow">in</span> <span class="n">exclusive_etl_task_obj_dict</span><span class="p">:</span>
                    <span class="n">exclusive_etl_task_instance</span> <span class="o">=</span> <span class="n">exclusive_etl_task_obj_dict</span><span class="p">[</span><span class="n">exclusive_etl_task_instance_task_id</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">exclusive_etl_task_instance</span><span class="o">.</span><span class="n">task_id</span> <span class="o">!=</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span>
                        <span class="c1">## Check if that task also lists us as Mutually exclusive</span>
                        <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">exclusive_etl_task_instance</span><span class="o">.</span><span class="n">mutually_exclusive_with_set</span><span class="p">:</span>
                            <span class="c1">## If so treat like another instance of self. We wait only on those before us in line (based on Task ID)</span>
                            <span class="k">if</span> <span class="n">dependent_reasons</span><span class="o">.</span><span class="n">OtherSelf</span><span class="o">.</span><span class="n">wait_on_status</span><span class="p">(</span><span class="n">exclusive_etl_task_instance</span><span class="o">.</span><span class="n">status</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span> <span class="o">&gt;</span> <span class="n">exclusive_etl_task_instance</span><span class="o">.</span><span class="n">task_id</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Waiting for other waiting instance {} with status {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exclusive_etl_task_instance</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">exclusive_etl_task_instance</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">exclusive_etl_task_instance</span><span class="p">,</span> <span class="n">dependent_reasons</span><span class="o">.</span><span class="n">OtherSelf</span><span class="p">)</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">allow_duplicates</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Task {etl_task} has to wait because another instance {other} is also waiting and arrived first.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">),</span> <span class="n">other</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">exclusive_etl_task_instance</span><span class="p">)))</span>
                                        <span class="n">dependencies_met</span> <span class="o">=</span> <span class="bp">False</span>
                                    <span class="k">except</span> <span class="n">CircularDependency</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                                        <span class="c1">## Somehow that task is waiting for us, so we&#39;ll skip waiting on it</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;Did not add dependency on {} due to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">exclusive_etl_task_instance</span><span class="p">),</span> <span class="n">error</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span> <span class="c1">## Other task isn&#39;t directly listing us a Mutually Exclusive (which it probably should)</span>
                            <span class="c1">## Do we add ourselves to exclusive_etl_task_instance.mutually_exclusive_with_set ?</span>
                            <span class="k">if</span> <span class="n">dependent_reasons</span><span class="o">.</span><span class="n">MutuallyExclusive</span><span class="o">.</span><span class="n">wait_on_status</span><span class="p">(</span><span class="n">exclusive_etl_task_instance</span><span class="o">.</span><span class="n">status</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Task {etl_task} has to wait because an instance of a mutually exclusive task {other} has not is_finished yet.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">),</span> <span class="n">other</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">exclusive_etl_task_instance</span><span class="p">)))</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Waiting for an instance of a mutually exclusive task {} (and maybe others)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exclusive_etl_task_instance</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">allow_duplicates</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">exclusive_etl_task_instance</span><span class="p">,</span> <span class="n">dependent_reasons</span><span class="o">.</span><span class="n">MutuallyExclusive</span><span class="p">)</span>
                                    <span class="n">dependencies_met</span> <span class="o">=</span> <span class="bp">False</span>
                                <span class="k">except</span> <span class="n">CircularDependency</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                                    <span class="c1">## Somehow that task is waiting for us, so we&#39;ll skip waiting on it</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;Did not add dependency on {} due to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">exclusive_etl_task_instance</span><span class="p">),</span> <span class="n">error</span><span class="p">))</span>

        <span class="c1">## Check to make sure there are no running jobs that list this job as a dependency</span>
        <span class="c1">## That would make this a source of that job and so we don&#39;t want to start running until that job finishes</span>
        <span class="c1">## For example given jobs A -&gt; B -&gt; C</span>
        <span class="c1">## If B is running then A should not start.  If C is running A should be OK to start.</span>
        <span class="k">if</span> <span class="n">dependencies_met</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">running_etl_task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span><span class="p">:</span>
                <span class="n">running_etl_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_by_id</span><span class="p">(</span><span class="n">running_etl_task_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dependent_reasons</span><span class="o">.</span><span class="n">Follower</span><span class="o">.</span><span class="n">wait_on_status</span><span class="p">(</span><span class="n">running_etl_task</span><span class="o">.</span><span class="n">status</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">dep_name</span> <span class="ow">in</span> <span class="n">running_etl_task</span><span class="o">.</span><span class="n">normalized_dependents_set</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">dep_name</span> <span class="o">==</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">running_etl_task</span><span class="p">,</span> <span class="n">dependent_reasons</span><span class="o">.</span><span class="n">Follower</span><span class="p">)</span>
                                <span class="n">dependencies_met</span> <span class="o">=</span> <span class="bp">False</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Task {etl_task} has to wait because following job {flw} is still active.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">etl_task</span><span class="o">=</span> <span class="n">etl_task</span><span class="p">,</span>
                                        <span class="n">flw</span><span class="o">=</span><span class="n">running_etl_task</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>
                            <span class="k">except</span> <span class="n">CircularDependency</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;Did not add dependency on {} due to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">running_etl_task</span><span class="p">),</span> <span class="n">error</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">dependencies_met</span><span class="p">:</span>
            <span class="c1">## check if parent has needs_to_ok_child_runs() == True which sets waiting_for_workflow flag</span>
            <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">waiting_for_workflow</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">parent_task</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;waiting_for_workflow: Cannot wait for non-existing parent!&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">failed</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">parent_task</span><span class="o">.</span><span class="n">thread_running</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;waiting_for_workflow: Parent not running to approve us! (parent={})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">parent_task</span><span class="p">)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">failed</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">## Send a message requesting etl_tasks run (should have already been sent)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_task_message</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">parent_task</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">ChildRunRequested</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">waiting_for_workflow</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">## Check for cpu right away (rather than waiting for the next pass)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_cpu</span><span class="p">(</span><span class="n">etl_task</span><span class="p">):</span>
                    <span class="c1">## If check_for_cpu didn&#39;t start the task, set it to wait for CPU</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">waiting_for_cpu</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">new</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">waiting_for_dependencies</span><span class="p">)</span>
            <span class="c1">## This should be non-empty here, but lets check</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">waiting_for_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">dependencies</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">current_blocking_flag</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">]</span>
                <span class="n">waiting_for</span> <span class="o">=</span> <span class="s2">&quot;Waiting for {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">waiting_for_list</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_task_summary_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">waiting_for</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_task_summary_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s2">&quot;Dependencies not met&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Scheduler.check_for_new_task_commands"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.check_for_new_task_commands">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_new_task_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Looks in the database repository for new task commands:</span>
<span class="sd">          * new task: Creates an ETLTask instance, and checks it&#39;s predesssors.</span>
<span class="sd">          * stop_requested: Sends a stop signal to the task</span>
<span class="sd">          * kill_requested: Sends s SIGKILL to terminate the task</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">##TODO: For new tasks this method of reading ETL_Tasks works. However, for stop requests it can fail.</span>
        <span class="c1">##      If the web-interface writes a stop request right as the scheduler updates the status message,</span>
        <span class="c1">##      the stop status will get overwritten by the status message update.</span>
        <span class="c1">##      Proposed solution: Create a scheduler message queue table that can be used to send messages</span>
        <span class="c1">##      to the scheduler. In environments where it&#39;s possible, the web-interface could also use</span>
        <span class="c1">##      a sockets interface to communicate directly with the scheduler.</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_tasks_query</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">valid_status_codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Status</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">stop_requested</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">kill_requested</span><span class="p">]]</span>
                <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ETL_Tasks</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ETL_Tasks</span><span class="o">.</span><span class="n">status_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">valid_status_codes</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span> <span class="n">ETL_Tasks</span><span class="o">.</span><span class="n">scheduler_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler_id</span> <span class="p">)</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">ETL_Tasks</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_new_tasks_query</span> <span class="o">=</span> <span class="n">query</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_tasks_query</span>
            <span class="k">for</span> <span class="n">task_rec</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">new</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Registering new task {r.modulename} id {r.task_id} parent_task_id {r.parent_task_id} root_task_id {r.root_task_id}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">task_rec</span><span class="p">))</span>
                    <span class="n">etl_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_etl_task_object_from_task_rec</span><span class="p">(</span><span class="n">task_rec</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">etl_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_task_to_active</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check_dependencies</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;--Failed registering new task {r.modulename} id {r.task_id} parent_task_id {r.parent_task_id} root_task_id {r.root_task_id}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">task_rec</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">stop_requested</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">etl_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span><span class="p">[</span><span class="n">task_rec</span><span class="o">.</span><span class="n">task_id</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">stop_task</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
                        <span class="c1">## Scheduler doesn&#39;t die no matter what!</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c1">#pylint: disable=broad-except </span>
                            <span class="n">task_rec</span><span class="o">.</span><span class="n">summary_message</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">## it&#39;s not running, just change it&#39;s listing to stopped</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Got request to stop task that is not active. task_id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_rec</span><span class="o">.</span><span class="n">task_id</span><span class="p">))</span>
                        <span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">stopped</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">kill_requested</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">etl_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span><span class="p">[</span><span class="n">task_rec</span><span class="o">.</span><span class="n">task_id</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">kill_task</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
                        <span class="c1">## Scheduler doesn&#39;t die no matter what!</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c1">#pylint: disable=broad-except </span>
                            <span class="n">task_rec</span><span class="o">.</span><span class="n">summary_message</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">## it&#39;s not running, just change it&#39;s listing to stopped</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Got request to kill task that is not active. task_id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_rec</span><span class="o">.</span><span class="n">task_id</span><span class="p">))</span>
                        <span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">stopped</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Got task with un-expected status in check_for_new_task_commands. task_id={} status={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_rec</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span><span class="p">))</span>
        <span class="c1">## Scheduler doesn&#39;t die no matter what!</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1">#pylint: disable=broad-except </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Scheduler.run_task"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting task {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;Starting process&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parent_to_child</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>  <span class="c1"># @UndefinedVariable</span>
            <span class="n">child_to_parent</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>  <span class="c1"># @UndefinedVariable</span>
            <span class="c1">## Run method to avoid serializing the task itself</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span> <span class="n">bi_etl</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">run_task</span><span class="p">,</span>  <span class="c1"># @UndefinedVariable</span>
                                              <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                                                      <span class="s1">&#39;task_name&#39;</span><span class="p">:</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                      <span class="s1">&#39;task_id&#39;</span><span class="p">:</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
                                                      <span class="s1">&#39;parent_task_id&#39;</span><span class="p">:</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">parent_task_id</span><span class="p">,</span>
                                                      <span class="s1">&#39;root_task_id&#39;</span><span class="p">:</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">root_task_id</span><span class="p">,</span>
                                                      <span class="s1">&#39;parent_to_child&#39;</span><span class="p">:</span><span class="n">parent_to_child</span><span class="p">,</span>
                                                      <span class="s1">&#39;child_to_parent&#39;</span><span class="p">:</span><span class="n">child_to_parent</span><span class="p">,</span>
                                                      <span class="s1">&#39;scheduler&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
                                                     <span class="p">}</span>
                           <span class="p">)</span>
            <span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">etl_task</span><span class="o">.</span><span class="n">thread_running</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="c1">## After starting add the Queues to our copy of the etl_task object</span>
            <span class="n">etl_task</span><span class="o">.</span><span class="n">parent_to_child</span> <span class="o">=</span> <span class="n">parent_to_child</span>
            <span class="n">etl_task</span><span class="o">.</span><span class="n">child_to_parent</span> <span class="o">=</span> <span class="n">child_to_parent</span>
            <span class="n">etl_task</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">process</span>

            <span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">started_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tasks_occupying_cpu</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;tasks_occupying_cpu = {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks_occupying_cpu</span><span class="p">))</span>
            <span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">pid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_task_summary_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">running</span><span class="p">)</span>
        <span class="c1">## Scheduler doesn&#39;t die no matter what!</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1">#pylint: disable=broad-except </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span>  <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_task_summary_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">failed</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Scheduler.stop_task"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.stop_task">[docs]</a>    <span class="k">def</span> <span class="nf">stop_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_task_summary_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s2">&quot;Stopping&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending stop request to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_task_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;stop&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">stop_signal_sent</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">is_finished</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">stopped</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Scheduler.kill_task"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.kill_task">[docs]</a>    <span class="k">def</span> <span class="nf">kill_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_task_summary_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s2">&quot;Killing&quot;</span><span class="p">)</span>
            <span class="n">etl_task</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">Status</span><span class="o">.</span><span class="n">kill_signal_sent</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">kill_signal_sent</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">is_finished</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">stopped</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_write_log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">time_now</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time_now</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">time_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

            <span class="n">msg_rec</span> <span class="o">=</span> <span class="n">ETL_Task_Log</span><span class="p">()</span>
            <span class="n">msg_rec</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">task_id</span>
            <span class="n">msg_rec</span><span class="o">.</span><span class="n">log_entry_ts</span> <span class="o">=</span> <span class="n">time_now</span>
            <span class="c1">## TODO: despite having the database column support uncode, cx_oracle is getting</span>
            <span class="c1">## errors when we send unicode through. So we&#39;ll trip it out for now.</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span><span class="s1">&#39;replace_tilda&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="n">msg_rec</span><span class="o">.</span><span class="n">log_entry</span> <span class="o">=</span> <span class="n">msg</span>
             
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">msg_rec</span><span class="p">)</span>

<div class="viewcode-block" id="Scheduler.flush_log_messages"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.flush_log_messages">[docs]</a>    <span class="k">def</span> <span class="nf">flush_log_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">,</span> <span class="n">time_now</span><span class="o">=</span> <span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">pending_log_msgs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;flush_log_messages task_id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">time_now</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">time_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="c1">## Make sure log messages are at least 1 second apart to avoid PK violation</span>
            <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">last_log_msg_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">time_now</span> <span class="o">-</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">last_log_msg_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)):</span>
                <span class="n">time_now</span> <span class="o">=</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">last_log_msg_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c1">## Set the new last time</span>
                <span class="n">etl_task</span><span class="o">.</span><span class="n">last_log_msg_time</span> <span class="o">=</span> <span class="n">time_now</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;flush_log_messages task_id={} add msg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">))</span>

            <span class="n">log_entry</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">pending_log_msgs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">log_entry</span><span class="p">,</span> <span class="n">time_now</span><span class="o">=</span><span class="n">time_now</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;flush_log_messages task_id={} commit&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">))</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">pending_log_msgs</span><span class="p">[:]</span>
            <span class="n">etl_task</span><span class="o">.</span><span class="n">last_log_msg_time</span> <span class="o">=</span> <span class="n">time_now</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;flush_log_messages task_id={} done&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Scheduler.check_if_log_message_flush_needed"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.check_if_log_message_flush_needed">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_log_message_flush_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">):</span>
        <span class="n">time_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">last_log_msg_time</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1">## Set the initial value to when we got called first, this will delay the first log storage until log_flush_interval</span>
            <span class="n">etl_task</span><span class="o">.</span><span class="n">last_log_msg_time</span> <span class="o">=</span> <span class="n">time_now</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">time_now</span> <span class="o">-</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">last_log_msg_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_flush_interval</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush_log_messages</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">time_now</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Scheduler.add_log_message"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.add_log_message">[docs]</a>    <span class="k">def</span> <span class="nf">add_log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">allow_duplicates</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;add_log_message task_id={} msg=---{}---&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
        <span class="n">msg_ok</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">last_log_msg</span><span class="p">:</span>
            <span class="n">etl_task</span><span class="o">.</span><span class="n">last_log_msg</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_duplicates</span><span class="p">:</span>
                <span class="n">msg_ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">msg_ok</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="c1">## Add an ending new line if it&#39;s not there</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">etl_task</span><span class="o">.</span><span class="n">pending_log_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;add_log_message task_id={} msg=---{}--- not saved (duplicate)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>

        <span class="c1">#self.check_if_log_message_flush_needed(etl_task)</span>
</div>
<div class="viewcode-block" id="Scheduler.process_statistics"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.process_statistics">[docs]</a>    <span class="k">def</span> <span class="nf">process_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>
        <span class="n">task_rec</span> <span class="o">=</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span>
        <span class="k">for</span> <span class="n">stat_name</span><span class="p">,</span> <span class="n">stat_value</span> <span class="ow">in</span> <span class="n">dict_to_pairs</span><span class="p">(</span><span class="n">stats</span><span class="p">):</span>
            <span class="n">stat_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">stat_name</span><span class="p">)</span>
            <span class="n">stat_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">stat_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stat_name</span> <span class="ow">in</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">stats</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">stat_name</span><span class="p">]</span> <span class="o">!=</span> <span class="n">stat_value</span><span class="p">:</span>
                    <span class="n">task_rec</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">stat_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ETL_Task_Stats</span><span class="p">(</span><span class="n">stat_name</span><span class="p">,</span> <span class="n">stat_value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">task_rec</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">stat_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ETL_Task_Stats</span><span class="p">(</span><span class="n">stat_name</span><span class="p">,</span> <span class="n">stat_value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_is_reloaded_instance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">class_obj</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Like isinstance but it should deal with modules that have been reloaded.</span>
<span class="sd">        Unlike isinstance it will NOT handle cases where msg inherits from class_obj</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">class_obj</span><span class="p">)</span>

<div class="viewcode-block" id="Scheduler.read_child_messages"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.read_child_messages">[docs]</a>    <span class="k">def</span> <span class="nf">read_child_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">):</span>
        <span class="n">is_reloaded_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_reloaded_instance</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">child_to_parent</span>
        <span class="c1">## Check that we actually have a queue</span>
        <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">is_reloaded_instance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">Statistics</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process_statistics</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="c1">## basestring won&#39;t be affected by reload, so use the normal isinstance</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">is_reloaded_instance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">TaskStopRequested</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_task_summary_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s2">&quot;Stopped&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">stopped</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span> <span class="c1">## Exception won&#39;t be affected by reload, so use the normal isinstance</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_task_summary_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">from_client</span><span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">is_reloaded_instance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">Status</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Status</span><span class="o">.</span><span class="n">stopped</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">stop_signal_sent</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;read_child_messages setting {} status to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">is_reloaded_instance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ChildSetDisplayName</span><span class="p">):</span>
                    <span class="n">child_task_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">child_task_id</span>
                    <span class="n">child_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_by_id</span><span class="p">(</span><span class="n">child_task_id</span><span class="p">)</span>
                    <span class="n">child_task</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">display_name</span>
                <span class="k">elif</span> <span class="n">is_reloaded_instance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ChildRunOK</span><span class="p">):</span>
                    <span class="n">child_task_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">child_task_id</span>
                    <span class="n">child_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_by_id</span><span class="p">(</span><span class="n">child_task_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">child_task</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Got ChildRunOK for invalid child task_id {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child_task_id</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">child_task</span><span class="o">.</span><span class="n">waiting_for_workflow</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Got ChildRunOK for {}, clearing waiting_for_workflow flag&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child_task</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">child_task</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">child_task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">waiting_for_workflow</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">child_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">waiting_for_dependencies</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;After ChildRunOK on {}, leaving status as {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child_task</span><span class="p">,</span> <span class="n">child_task</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">child_task</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">is_reloaded_instance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ChildNotOccupyingCPU</span><span class="p">):</span>
                    <span class="n">child_task_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">child_task_id</span>
                    <span class="k">if</span> <span class="n">child_task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_occupying_cpu</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tasks_occupying_cpu</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">child_task_id</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">child_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_by_id</span><span class="p">(</span><span class="n">child_task_id</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{} Sent ChildNotOccupyingCPU but it wasn&#39;t occupying CPU&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child_task</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">child_task</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">is_reloaded_instance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ChildOccupyingCPU</span><span class="p">):</span>
                    <span class="n">child_task_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">child_task_id</span>
                    <span class="k">if</span> <span class="n">child_task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_occupying_cpu</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tasks_occupying_cpu</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">child_task_id</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">child_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_by_id</span><span class="p">(</span><span class="n">child_task_id</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{} Sent ChildOccupyingCPU but it already was occupying CPU&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child_task</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">child_task</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="c1">#===============================================================</span>
                <span class="c1"># ## Added these extra call to catch an odd scenario where isinstance failed (now using _is_reloaded_instance)</span>
                <span class="c1"># elif str(type(msg)) == &quot;&lt;enum &#39;Status&#39;&gt;&quot;:</span>
                <span class="c1">#     self.log.warning(&quot;{} bases={} matched type(msg) == &lt;enum &#39;Status&#39;&gt; and not isinstance(msg, Status)&quot;.format(msg, type(msg).__bases__))</span>
                <span class="c1">#     self.log.warning(&quot;qualname = {}&quot;.format(type(msg).__qualname__))</span>
                <span class="c1">#     if etl_task.status not in [Status.stopped, Status.stop_signal_sent]:</span>
                <span class="c1">#         self.log.debug(&quot;read_child_messages setting {} status to {}&quot;.format(etl_task, msg))</span>
                <span class="c1">#         self.set_task_status(etl_task, Status(msg))</span>
                <span class="c1"># elif repr(msg).startswith(&#39;&lt;Status.&#39;):</span>
                <span class="c1">#     self.log.warning(&quot;{} type={} matched repr(msg).startswith(&#39;&lt;Status.&#39;) and not isinstance(msg, Status)&quot;.format(msg, type(msg)))</span>
                <span class="c1">#     if etl_task.status not in [Status.stopped, Status.stop_signal_sent]:</span>
                <span class="c1">#         self.log.debug(&quot;read_child_messages setting {} status to {}&quot;.format(etl_task, msg))</span>
                <span class="c1">#         self.set_task_status(etl_task, Status(msg))</span>
                <span class="c1">#===============================================================</span>
                <span class="k">elif</span> <span class="n">is_reloaded_instance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">SummaryMessage</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">append_task_summary_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">summary_message</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_task_summary_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">summary_message</span><span class="p">,</span> <span class="n">from_client</span><span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Got unexpected message from client: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Scheduler.check_if_done"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.check_if_done">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calling is_alive: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">is_finished</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Task {} is completed but is_alive is still true.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;...Process={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">process</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;...Process PID={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;thread_running&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">thread_running</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calling join: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s2">&quot;Cleaning up thread&quot;</span><span class="p">)</span>
                    <span class="n">etl_task</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_occupying_cpu</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tasks_occupying_cpu</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;tasks_occupying_cpu = {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks_occupying_cpu</span><span class="p">))</span>
                    <span class="n">etl_task</span><span class="o">.</span><span class="n">thread_running</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">exitcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;etl_task {} had exit code {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">),</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">exitcode</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s2">&quot;exit code {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">exitcode</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">succeeded</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_task_summary_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s2">&quot;Done&quot;</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Status</span><span class="o">.</span><span class="n">running</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">succeeded</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">ancestors_running</span><span class="p">]:</span>
                    <span class="n">children_done</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">children_status</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">for</span> <span class="n">child_task</span> <span class="ow">in</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">child_task</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">child_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;child_task.status {} != child_task.task_rec.Status {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child_task</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">child_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span><span class="s1">&#39;ERROR child_task.status {} != child_task.task_rec.Status {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child_task</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">child_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span><span class="p">))</span>
                            <span class="n">child_task</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">child_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">child_task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">is_finished</span><span class="p">():</span>
                            <span class="n">children_done</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;check_if_done etl_task {} waiting for child {} in status {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">child_task</span><span class="p">),</span> <span class="n">child_task</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s2">&quot;Waiting for child {} in status {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">child_task</span><span class="p">),</span> <span class="n">child_task</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span> <span class="c1">## Get the &quot;worst&quot; child status... the lowest.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s2">&quot;Collecting status for child {} in status {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">child_task</span><span class="p">),</span> <span class="n">child_task</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">children_status</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">children_status</span> <span class="o">=</span> <span class="n">child_task</span><span class="o">.</span><span class="n">status</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;check_if_done etl_task {} first child status {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">),</span> <span class="n">children_status</span><span class="p">))</span>
                            <span class="k">elif</span> <span class="n">child_task</span><span class="o">.</span><span class="n">status</span> <span class="o">&lt;</span> <span class="n">children_status</span><span class="p">:</span>
                                <span class="n">children_status</span> <span class="o">=</span> <span class="n">child_task</span><span class="o">.</span><span class="n">status</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;check_if_done etl_task {} new low child status {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">),</span> <span class="n">children_status</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">children_done</span><span class="p">:</span>
                        <span class="c1">## Set is_finished time</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s2">&quot;Task and all ancestors is_finished&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_task_summary_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s1">&#39;Done&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;check_if_done: {} not is_alive and children_done. etl_task.status={} children_status={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">),</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">children_status</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">children_status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">children_status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">ancestor_failed</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">children_status</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1">## Double check for child messages that might update our status</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">read_child_messages</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
                            <span class="c1">## If still running then task must have failed</span>
                            <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">failed</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;check_if_done: {} chilren_done etl_task.status={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">),</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s2">&quot;Final status = {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1">## children not done</span>
                        <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">Status</span><span class="o">.</span><span class="n">ancestors_running</span><span class="p">:</span>  <span class="c1">## From above we know status is in [Status.running, Status.succeeded, Status.ancestors_running]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">ancestors_running</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">stop_signal_sent</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">stopped</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">stopped</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">kill_signal_sent</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">killed</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unexpected status {} in check_if_done for task {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">failed</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;check_if_done: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="Scheduler.check_for_previous_instance_tasks"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.check_for_previous_instance_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_previous_instance_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Looks in the database repository for tasks from a previous instance.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">running_status_codes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">Status</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">is_finished</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">new</span><span class="p">:</span>
                <span class="n">running_status_codes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ETL_Tasks</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ETL_Tasks</span><span class="o">.</span><span class="n">status_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">running_status_codes</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span> <span class="n">ETL_Tasks</span><span class="o">.</span><span class="n">scheduler_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler_id</span> <span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">ETL_Tasks</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>
        <span class="n">our_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">()</span>
        <span class="n">wait_pids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">task_rec</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found task {task_rec.task_id} {task_rec.modulename} for previous scheduler instance listed as active&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_rec</span><span class="o">=</span><span class="n">task_rec</span><span class="p">))</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="n">task_rec</span><span class="o">.</span><span class="n">pid</span>
            <span class="k">if</span> <span class="n">pid</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">psutil</span><span class="o">.</span><span class="n">pid_exists</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">exe</span><span class="p">()</span> <span class="o">==</span> <span class="n">our_process</span><span class="o">.</span><span class="n">exe</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">gids</span><span class="p">()</span> <span class="o">==</span> <span class="n">our_process</span><span class="o">.</span><span class="n">gids</span><span class="p">()):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  {task_rec.task_id} {task_rec.modulename} is still running as pid {task_rec.pid}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_rec</span><span class="o">=</span><span class="n">task_rec</span><span class="p">))</span>
                        <span class="n">wait_pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
                        <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                        <span class="n">task_rec</span><span class="o">.</span><span class="n">summary_message</span> <span class="o">=</span> <span class="s2">&quot;Killed (active task PID) on scheduler restart. Prior status was {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">task_rec</span><span class="o">.</span><span class="n">summary_message</span> <span class="o">=</span> <span class="s2">&quot;Killed (PID didn&#39;t match) on scheduler restart. Prior status was {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span><span class="p">)</span>
                <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">task_rec</span><span class="o">.</span><span class="n">summary_message</span> <span class="o">=</span> <span class="s2">&quot;Killed (PID not active) on scheduler restart. Prior status was {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span><span class="p">)</span>
            <span class="n">task_rec</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">killed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  {task_rec.task_id} {task_rec.modulename} new status = {task_rec.status_id}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_rec</span><span class="o">=</span><span class="n">task_rec</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wait_pids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for previous schedulers tasks to end.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psutil</span><span class="o">.</span><span class="n">wait_procs</span><span class="p">(</span><span class="n">wait_pids</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done waiting for previous schedulers tasks to end.&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Scheduler.delete_old_run_logs"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.delete_old_run_logs">[docs]</a>    <span class="k">def</span> <span class="nf">delete_old_run_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ETL_Tasks</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ETL_Tasks</span><span class="o">.</span><span class="n">submitted_date</span> <span class="o">&lt;</span>
                             <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">days_to_keep_run_logs</span><span class="p">)</span> <span class="p">)</span>
                             <span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Scheduler.purge_old_lager_parameters"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.purge_old_lager_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">purge_old_lager_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ETL_Tasks</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ETL_Tasks</span><span class="o">.</span><span class="n">submitted_date</span> <span class="o">&lt;</span>
                             <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">days_to_keep_large_parameters</span><span class="p">)</span> <span class="p">)</span>
                             <span class="p">)</span>
        <span class="k">for</span> <span class="n">etl_task_rec</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">etl_task_rec</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">param_value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_large_parameter_size</span><span class="p">:</span>
                    <span class="n">param</span><span class="o">.</span><span class="n">param_value</span> <span class="o">=</span> <span class="s1">&#39;PURGED&#39;</span>
</div>
<div class="viewcode-block" id="Scheduler.check_for_required_table_maintenance"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.check_for_required_table_maintenance">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_required_table_maintenance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">## Delete etl_task records from the database after retention period X days</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_table_maintenance_run</span> <span class="ow">is</span> <span class="bp">None</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_table_maintenance_run</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
           <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing table cleanup&quot;</span><span class="p">)</span>
            <span class="c1">#logging.getLogger(&#39;sqlalchemy.engine&#39;).setLevel(logging.DEBUG)</span>
            <span class="c1">#logging.getLogger(&#39;sqlalchemy.engine.base.Engine&#39;).setLevel(logging.DEBUG)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_old_run_logs</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">purge_old_lager_parameters</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_table_maintenance_run</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Scheduler.start_monitoring"><a class="viewcode-back" href="../../../bi_etl.scheduler.scheduler.html#bi_etl.scheduler.scheduler.Scheduler.start_monitoring">[docs]</a>    <span class="k">def</span> <span class="nf">start_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#logging.getLogger(&#39;sqlalchemy.engine&#39;).setLevel(logging.DEBUG)</span>
        <span class="c1">#logging.getLogger(&#39;sqlalchemy.engine.base.Engine&#39;).setLevel(logging.DEBUG)</span>
        <span class="c1">#logging.getLogger(&#39;sqlalchemy.orm&#39;).setLevel(logging.DEBUG)</span>

        <span class="c1">## Check for tasks that are listed as running, or waiting from the last run of the scheduler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;check_for_previous_instance_tasks&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_for_previous_instance_tasks</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_etl_classes</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running status code upsert task&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_task_by_class</span><span class="p">(</span><span class="n">ETL_Task_Status_CD</span><span class="p">)</span>

        <span class="c1">## TODO: Remove these testing jobs</span>
        <span class="c1">#=======================================================================</span>
        <span class="c1"># if self.scheduler_id == 3:</span>
        <span class="c1">#     wf_task_id = self.add_task_by_partial_name(&#39;sap_stg.file_upload_workflow&#39;, )</span>
        <span class="c1">#     self.log.info(&quot;Created test file_upload_workflow task id {}&quot;.format(wf_task_id))</span>
        <span class="c1">#</span>
        <span class="c1">#     wf_task_id = self.add_task_by_partial_name(&#39;sap_stg.file_upload_workflow&#39;, )</span>
        <span class="c1">#     self.log.info(&quot;Created test file_upload_workflow task id {}&quot;.format(wf_task_id))</span>
        <span class="c1">#=======================================================================</span>
        <span class="c1">#self.add_task_by_class(d_person_hst)</span>
        <span class="c1">#self.add_task_by_class(f_change_request_daily)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting monitoring for new jobs&quot;</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_for_new_task_commands</span><span class="p">()</span>

                <span class="n">list_to_remove</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">etl_task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span><span class="p">:</span>
                    <span class="n">etl_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span><span class="p">[</span><span class="n">etl_task_id</span><span class="p">]</span>
                    <span class="c1">#self.log.debug(&quot;Checking on task {}&quot;.format(repr(etl_task)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="p">)</span>        
                    <span class="n">status</span> <span class="o">=</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="o">.</span><span class="n">is_finished</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking task {} with status {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">),</span> <span class="n">status</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">thread_running</span> <span class="ow">or</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">is_termination_pending</span><span class="p">():</span>
                        <span class="c1">## Read any messages in the queue for this task</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">read_child_messages</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check_if_done</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">status</span><span class="o">.</span><span class="n">is_finished</span><span class="p">():</span>
                        <span class="c1">## Check if we can remove from memory (active tasks)</span>
                        <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">root_task_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">finished_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">task_rec</span><span class="o">.</span><span class="n">finished_date</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_keep_finished_tasks</span><span class="p">):</span>
                                    <span class="n">list_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Task {} has is_finished status but no finished_date.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)))</span>
                    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">ancestors_running</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check_if_done</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">waiting_for_cpu</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check_for_cpu</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">waiting_for_dependencies</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check_dependencies</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unexpected status {} in monitoring loop for task {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">etl_task</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">flush_log_messages</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
                <span class="c1"># End for loop of etl_task&#39;s</span>

                <span class="n">etl_task</span> <span class="o">=</span> <span class="bp">None</span>

                <span class="k">for</span> <span class="n">etl_task</span> <span class="ow">in</span> <span class="n">list_to_remove</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_active_task_record</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>

                <span class="c1">## Update heart beat time in etl_schedulers table</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">heatbeat_now</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">check_for_required_table_maintenance</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">CircularDependency</span><span class="p">,</span> <span class="n">DependencyDeeperThanLimit</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_log_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_task_summary_message</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="s2">&quot;Invalid dependency. See log.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_task_status</span><span class="p">(</span><span class="n">etl_task</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">failed</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flush_log_messages</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
            <span class="c1">## Scheduler doesn&#39;t die no matter what!</span>
            <span class="k">except</span> <span class="n">DetachedInstanceError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1">#pylint: disable=broad-except </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>                
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c1">#pylint: disable=broad-except</span>
                    <span class="c1">## OK, things are more serious here. Rollback? </span>
                    <span class="c1">## We might just not have a database connection anymore</span>
                    <span class="c1">## We&#39;ll let a rollback failure kill the Scheduler (outer shell script should re-start it) </span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;KeyboardInterrupt, killing tasks&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">etl_task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span><span class="p">:</span>
                    <span class="n">etl_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span><span class="p">[</span><span class="n">etl_task_id</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">thread_running</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">kill_task</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;KeyboardInterrupt done killing tasks&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Wait {} sec before checking status again&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_check_interval</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_check_interval</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;KeyboardInterrupt killing tasks&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="c1">## Different DBs seem to give different exceptions here</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c1">#pylint: disable=broad-except</span>
                    <span class="c1">## Already exiting </span>
                    <span class="k">pass</span>
                <span class="k">for</span> <span class="n">etl_task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span><span class="p">:</span>
                    <span class="n">etl_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_task_by_id</span><span class="p">[</span><span class="n">etl_task_id</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">etl_task</span><span class="o">.</span><span class="n">thread_running</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">kill_task</span><span class="p">(</span><span class="n">etl_task</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c1">#pylint: disable=broad-except</span>
                            <span class="c1">## Already exiting </span>
                            <span class="k">pass</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;KeyboardInterrupt done killing tasks&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span>

</div></div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="p">()</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="n">start_monitoring</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">bi_etl 0.5 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Derek Wood.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>